<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Appointment - kwikMed</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <!-- Add jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      .hero-bg {
        background-color: #fff8e7;
        border-radius: 2rem;
      }

      .feature-icon {
        width: 48px;
        height: 48px;
        background: #e6f3ff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .service-card {
        transition: all 0.3s ease;
      }

      .service-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      /* Navbar responsive for button */
      @media (max-width: 991px) {
        .mobile-buttons {
          width: 30% !important;
          align-items: flex-start !important;
          display: flex !important;
          flex-direction: column !important;
          gap: 10px !important;
        }
      }

      .appointment-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
        background-color: #f8f9fa;
        border-radius: 1rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      /* Updated hospital card styling to match test directory cards */
      .hospital-card {
        transition: transform 0.3s;
        border: 1px solid #ddd;
        border-radius: 1rem;
        padding: 20px;
        text-align: center;
        background-color: #f9f9f9;
        position: relative;
        height: 180px;
        width: 260px;
        margin: 10px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .hospital-card:hover {
        transform: translateY(-15px);
        box-shadow: 0 4px 8px rgba(64, 187, 52, 1);
      }

      .hospital-card.selected {
        border-color: #198754;
        background-color: #f0f9f4;
        box-shadow: 0 4px 8px rgba(64, 187, 52, 1);
      }

      /* Hospital cards container */
      #hospitalsContainer {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
      }

      .time-slot {
        display: inline-block;
        padding: 0.5rem 1rem;
        margin: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .time-slot:hover {
        background-color: #e9ecef;
      }

      .time-slot.selected {
        background-color: #198754;
        color: white;
        border-color: #198754;
      }

      .step {
        display: none;
      }

      .step.active {
        display: block;
      }

      .confirmation-message {
        text-align: center;
        padding: 2rem;
      }

      .confirmation-icon {
        font-size: 5rem;
        color: #198754;
        margin-bottom: 1rem;
      }

      .select-hospital {
        margin-top: 10px;
      }

      /* Styling for appointment ticket */
      .appointment-ticket {
        border: 2px solid #198754;
        border-radius: 10px;
        padding: 15px;
        margin-top: 20px;
        background-color: #f0f9f4;
      }

      .appointment-ticket .ticket-header {
        border-bottom: 1px solid #198754;
        padding-bottom: 10px;
        margin-bottom: 10px;
      }

      .appointment-ticket .ticket-logo {
        max-width: 150px;
      }

      .ticket-template {
        display: none;
      }

      .download-ticket-btn {
        margin-top: 15px;
      }
    </style>
  </head>

  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
      <div class="container-fluid">
        <a class="navbar-brand" href="#"
          ><img style="width: 15rem" src="images/logo.png" alt="Logo"
        /></a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="index.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="index.html#services">Services</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">About Us</a>
            </li>
          </ul>

          <div class="d-grid d-md-flex" id="navbarButtons">
            <div class="mobile-buttons">
              <a class="btn btn-success mb-2" href="#">Sign In</a>
              <a class="btn btn-success mb-2" href="#">Sign Up</a>
              <a class="btn btn-success mb-2" href="index.html#contactus"
                >Contact Us</a
              >
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Appointment Booking Section -->
    <div class="container my-5">
      <div class="appointment-container">
        <h2 class="text-center mb-4">Book Your Medical Appointment</h2>

        <div class="progress mb-4">
          <div
            class="progress-bar bg-success"
            role="progressbar"
            style="width: 33.33%"
            aria-valuenow="33"
            aria-valuemin="0"
            aria-valuemax="100"
          >
            Step 1
          </div>
        </div>

        <!-- Step 1: City & Hospital Selection -->
        <div class="step active" id="step1">
          <h4 class="mb-3">Select City and Hospital</h4>

          <div class="mb-3">
            <label for="citySelect" class="form-label">City</label>
            <select
              class="form-select"
              id="citySelect"
              onchange="updateHospitals()"
            >
              <option value="">Select a city</option>
              <option value="Mumbai">Mumbai</option>
              <option value="Delhi">Delhi</option>
              <option value="Bangalore">Bangalore</option>
              <option value="Chennai">Chennai</option>
              <option value="Kolkata">Kolkata</option>
              <option value="Hyderabad">Hyderabad</option>
              <option value="Pune">Pune</option>
              <option value="Ahmedabad">Ahmedabad</option>
              <option value="Jaipur">Jaipur</option>
            </select>
          </div>

          <div id="hospitalsContainer" class="mt-4">
            <p class="text-muted">
              Please select a city to view available hospitals
            </p>
          </div>

          <div class="d-flex justify-content-end mt-4">
            <button
              class="btn btn-success"
              onclick="goToStep(2)"
              id="nextToStep2"
              disabled
            >
              Next
            </button>
          </div>
        </div>

        <!-- Step 2: Doctor & Time Selection -->
        <div class="step" id="step2">
          <h4 class="mb-3">Select Doctor and Appointment Time</h4>

          <div class="mb-3">
            <label for="departmentSelect" class="form-label">Department</label>
            <select
              class="form-select"
              id="departmentSelect"
              onchange="updateDoctors()"
            >
              <option value="">Select a department</option>
              <option value="Cardiology">Cardiology</option>
              <option value="Neurology">Neurology</option>
              <option value="Orthopedics">Orthopedics</option>
              <option value="Pediatrics">Pediatrics</option>
              <option value="Gynecology">Gynecology</option>
              <option value="Dermatology">Dermatology</option>
              <option value="ENT">ENT</option>
              <option value="Ophthalmology">Ophthalmology</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="doctorSelect" class="form-label">Doctor</label>
            <select class="form-select" id="doctorSelect" disabled>
              <option value="">Select a doctor</option>
            </select>
          </div>

          <div class="mt-4">
            <h5>Available Time Slots</h5>
            <p class="text-muted mb-3">Select a preferred appointment time</p>
            <div id="timeSlots" class="d-flex flex-wrap"></div>
          </div>

          <div class="d-flex justify-content-between mt-4">
            <button class="btn btn-outline-secondary" onclick="goToStep(1)">
              Back
            </button>
            <button
              class="btn btn-success"
              onclick="goToStep(3)"
              id="nextToStep3"
              disabled
            >
              Next
            </button>
          </div>
        </div>

        <!-- Step 3: Patient Information -->
        <div class="step" id="step3">
          <h4 class="mb-3">Your Information</h4>

          <form id="patientForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="firstName" class="form-label">First Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="firstName"
                  required
                />
              </div>
              <div class="col-md-6">
                <label for="lastName" class="form-label">Last Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="lastName"
                  required
                />
              </div>
              <div class="col-md-6">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" required />
              </div>
              <div class="col-md-6">
                <label for="phone" class="form-label">Phone Number</label>
                <input type="tel" class="form-control" id="phone" required />
              </div>
              <div class="col-12">
                <label for="medicalIssue" class="form-label"
                  >Medical Issue/Symptoms</label
                >
                <textarea
                  class="form-control"
                  id="medicalIssue"
                  rows="3"
                  required
                ></textarea>
              </div>
            </div>

            <div class="d-flex justify-content-between mt-4">
              <button
                type="button"
                class="btn btn-outline-secondary"
                onclick="goToStep(2)"
              >
                Back
              </button>
              <button
                type="button"
                class="btn btn-success"
                onclick="confirmAppointment()"
              >
                Confirm Appointment
              </button>
            </div>
          </form>
        </div>

        <!-- Step 4: Confirmation -->
        <div class="step" id="step4">
          <div class="confirmation-message">
            <div class="confirmation-icon">✓</div>
            <h3 class="mb-3">Appointment Confirmed!</h3>
            <p>
              Your appointment has been successfully booked. A confirmation has
              been sent to your email.
            </p>
            <div class="mt-4">
              <h5>Appointment Details:</h5>
              <div id="appointmentDetails" class="mt-3 text-start"></div>
            </div>

            <!-- Add appointment ticket section -->
            <div class="mt-4">
              <button
                id="downloadTicketBtn"
                class="btn btn-primary download-ticket-btn"
              >
                <i class="bi bi-download"></i> Download Appointment Ticket
              </button>
            </div>

            <div class="mt-4">
              <a href="index.html" class="btn btn-outline-success me-2">Home</a>
              <a href="tid.html" class="btn btn-success">View Tests</a>
            </div>
          </div>
        </div>

        <!-- Hidden ticket template for PDF generation -->
        <div id="ticketTemplate" class="ticket-template">
          <div class="ticket-content"></div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-body-tertiary text-center py-4 mt-5">
      <div class="container">
        <p class="mb-0">© 2025 kwikmed. All Rights Reserved.</p>
        <p>
          Follow us on: <a href="#" class="text-success ms-2">Facebook</a> |
          <a href="#" class="text-success ms-2">Twitter</a> |
          <a href="#" class="text-success ms-2">Instagram</a>
        </p>
      </div>
    </footer>

    <script>
      // Hospital data
      const hospitals = {
        Mumbai: [
          {
            id: 1,
            name: "Lilavati Hospital",
            address: "Bandra West, Mumbai",
            rating: 4.8,
          },
          {
            id: 2,
            name: "Breach Candy Hospital",
            address: "Breach Candy, Mumbai",
            rating: 4.7,
          },
          {
            id: 3,
            name: "Kokilaben Dhirubhai Ambani Hospital",
            address: "Andheri West, Mumbai",
            rating: 4.9,
          },
        ],
        Delhi: [
          {
            id: 4,
            name: "AIIMS Delhi",
            address: "Ansari Nagar East, New Delhi",
            rating: 4.9,
          },
          {
            id: 5,
            name: "Fortis Escorts Heart Institute",
            address: "Okhla, New Delhi",
            rating: 4.8,
          },
          {
            id: 6,
            name: "Apollo Hospital",
            address: "Sarita Vihar, New Delhi",
            rating: 4.7,
          },
        ],
        Bangalore: [
          {
            id: 7,
            name: "Manipal Hospital",
            address: "Whitefield, Bangalore",
            rating: 4.8,
          },
          {
            id: 8,
            name: "Narayana Health City",
            address: "Bommasandra, Bangalore",
            rating: 4.7,
          },
          {
            id: 9,
            name: "Columbia Asia Hospital",
            address: "Whitefield, Bangalore",
            rating: 4.6,
          },
        ],
        Chennai: [
          {
            id: 10,
            name: "Apollo Hospital",
            address: "Greams Road, Chennai",
            rating: 4.9,
          },
          {
            id: 11,
            name: "Fortis Malar Hospital",
            address: "Adyar, Chennai",
            rating: 4.7,
          },
          {
            id: 12,
            name: "MIOT International",
            address: "Manapakkam, Chennai",
            rating: 4.8,
          },
        ],
        Kolkata: [
          {
            id: 13,
            name: "AMRI Hospital",
            address: "Dhakuria, Kolkata",
            rating: 4.7,
          },
          {
            id: 14,
            name: "Fortis Hospital",
            address: "Anandapur, Kolkata",
            rating: 4.8,
          },
          {
            id: 15,
            name: "Peerless Hospital",
            address: "Panchasayar, Kolkata",
            rating: 4.6,
          },
        ],
        Hyderabad: [
          {
            id: 16,
            name: "Apollo Hospital",
            address: "Jubilee Hills, Hyderabad",
            rating: 4.8,
          },
          {
            id: 17,
            name: "KIMS Hospital",
            address: "Secunderabad, Hyderabad",
            rating: 4.7,
          },
          {
            id: 18,
            name: "Yashoda Hospital",
            address: "Somajiguda, Hyderabad",
            rating: 4.7,
          },
        ],
        Pune: [
          {
            id: 19,
            name: "Ruby Hall Clinic",
            address: "Sassoon Road, Pune",
            rating: 4.8,
          },
          {
            id: 20,
            name: "Jehangir Hospital",
            address: "Sassoon Road, Pune",
            rating: 4.7,
          },
          {
            id: 21,
            name: "Aditya Birla Memorial Hospital",
            address: "Thergaon, Pune",
            rating: 4.6,
          },
        ],
        Ahmedabad: [
          {
            id: 22,
            name: "Sterling Hospital",
            address: "Gurukul, Ahmedabad",
            rating: 4.7,
          },
          {
            id: 23,
            name: "Apollo Hospital",
            address: "Gandhinagar, Ahmedabad",
            rating: 4.8,
          },
          {
            id: 24,
            name: "Zydus Hospital",
            address: "Thaltej, Ahmedabad",
            rating: 4.7,
          },
        ],
        Jaipur: [
          {
            id: 25,
            name: "Fortis Escorts Hospital",
            address: "Malviya Nagar, Jaipur",
            rating: 4.7,
          },
          {
            id: 26,
            name: "Narayana Multispeciality Hospital",
            address: "Jaipur",
            rating: 4.6,
          },
          {
            id: 27,
            name: "SMS Hospital",
            address: "JLN Marg, Jaipur",
            rating: 4.5,
          },
        ],
      };

      // Doctors data
      const doctors = {
        Cardiology: [
          {
            id: 1,
            name: "Dr. Rahul Sharma",
            qualification: "MD, DM Cardiology",
            experience: "15 years",
          },
          {
            id: 2,
            name: "Dr. Anjali Mehta",
            qualification: "MD, DNB Cardiology",
            experience: "12 years",
          },
          {
            id: 3,
            name: "Dr. Vikram Patel",
            qualification: "MBBS, MD Cardiology",
            experience: "10 years",
          },
        ],
        Neurology: [
          {
            id: 4,
            name: "Dr. Priya Singh",
            qualification: "MD, DM Neurology",
            experience: "14 years",
          },
          {
            id: 5,
            name: "Dr. Anil Kumar",
            qualification: "MBBS, DNB Neurology",
            experience: "16 years",
          },
          {
            id: 6,
            name: "Dr. Shalini Gupta",
            qualification: "MD, DNB Neurology",
            experience: "11 years",
          },
        ],
        Orthopedics: [
          {
            id: 7,
            name: "Dr. Rajesh Khanna",
            qualification: "MS Orthopedics",
            experience: "18 years",
          },
          {
            id: 8,
            name: "Dr. Sunita Rao",
            qualification: "MBBS, DNB Orthopedics",
            experience: "13 years",
          },
          {
            id: 9,
            name: "Dr. Praveen Verma",
            qualification: "MS, MCh Orthopedics",
            experience: "15 years",
          },
        ],
        Pediatrics: [
          {
            id: 10,
            name: "Dr. Neha Joshi",
            qualification: "MD Pediatrics",
            experience: "12 years",
          },
          {
            id: 11,
            name: "Dr. Sameer Khan",
            qualification: "MBBS, DCH",
            experience: "9 years",
          },
          {
            id: 12,
            name: "Dr. Meera Reddy",
            qualification: "MD, DNB Pediatrics",
            experience: "14 years",
          },
        ],
        Gynecology: [
          {
            id: 13,
            name: "Dr. Seema Aggarwal",
            qualification: "MS Gynecology",
            experience: "17 years",
          },
          {
            id: 14,
            name: "Dr. Ritu Sharma",
            qualification: "MBBS, DGO",
            experience: "13 years",
          },
          {
            id: 15,
            name: "Dr. Aarti Patel",
            qualification: "MD, DNB Gynecology",
            experience: "15 years",
          },
        ],
        Dermatology: [
          {
            id: 16,
            name: "Dr. Vivek Mishra",
            qualification: "MD Dermatology",
            experience: "11 years",
          },
          {
            id: 17,
            name: "Dr. Kavita Shah",
            qualification: "MBBS, DVD",
            experience: "9 years",
          },
          {
            id: 18,
            name: "Dr. Mohan Desai",
            qualification: "MD, DNB Dermatology",
            experience: "14 years",
          },
        ],
        ENT: [
          {
            id: 19,
            name: "Dr. Suresh Menon",
            qualification: "MS ENT",
            experience: "16 years",
          },
          {
            id: 20,
            name: "Dr. Priyanka Gupta",
            qualification: "MBBS, DLO",
            experience: "10 years",
          },
          {
            id: 21,
            name: "Dr. Ajay Nair",
            qualification: "MS, DNB ENT",
            experience: "13 years",
          },
        ],
        Ophthalmology: [
          {
            id: 22,
            name: "Dr. Rohit Malhotra",
            qualification: "MS Ophthalmology",
            experience: "15 years",
          },
          {
            id: 23,
            name: "Dr. Sarika Jain",
            qualification: "MBBS, DO",
            experience: "11 years",
          },
          {
            id: 24,
            name: "Dr. Dinesh Kapoor",
            qualification: "MD, DNB Ophthalmology",
            experience: "17 years",
          },
        ],
      };

      // Global variables to store selections
      let selectedHospital = null;
      let selectedDoctor = null;
      let selectedTimeSlot = null;
      let currentStep = 1;

      // Update progress bar based on current step
      function updateProgressBar(step) {
        const progressBar = document.querySelector(".progress-bar");
        progressBar.style.width = `${33.33 * step}%`;
        progressBar.textContent = `Step ${step}`;
        progressBar.setAttribute("aria-valuenow", 33.33 * step);
      }

      // Go to specified step
      function goToStep(step) {
        // Validate current step before proceeding
        if (step > currentStep && !validateStep(currentStep)) {
          return false;
        }

        // Hide all steps
        document.querySelectorAll(".step").forEach((el) => {
          el.classList.remove("active");
        });

        // Show current step
        document.getElementById(`step${step}`).classList.add("active");
        currentStep = step;
        updateProgressBar(Math.min(step, 3));

        // Special handling for each step
        if (step === 2) {
          updateDepartmentDoctors();
          generateTimeSlots();
        }

        return true;
      }

      // Validate current step
      function validateStep(step) {
        if (step === 1 && !selectedHospital) {
          alert("Please select a hospital before proceeding.");
          return false;
        }
        if (step === 2 && (!selectedDoctor || !selectedTimeSlot)) {
          alert("Please select a doctor and time slot before proceeding.");
          return false;
        }
        return true;
      }

      // Update hospitals list based on selected city
      function updateHospitals() {
        const city = document.getElementById("citySelect").value;
        const hospitalsContainer =
          document.getElementById("hospitalsContainer");
        hospitalsContainer.innerHTML = "";

        if (!city) {
          hospitalsContainer.innerHTML =
            '<p class="text-muted">Please select a city to view available hospitals</p>';
          document.getElementById("nextToStep2").disabled = true;
          return;
        }

        const cityHospitals = hospitals[city] || [];
        if (cityHospitals.length === 0) {
          hospitalsContainer.innerHTML =
            '<p class="text-muted">No hospitals available in this city</p>';
          document.getElementById("nextToStep2").disabled = true;
          return;
        }

        cityHospitals.forEach((hospital) => {
          const hospitalCard = document.createElement("div");
          hospitalCard.className = "hospital-card";
          hospitalCard.dataset.id = hospital.id;
          hospitalCard.innerHTML = `
            <h5>${hospital.name}</h5>
            <p class="text-muted mb-1">${hospital.address}</p>
            <div class="text-warning">
              ${generateStars(hospital.rating)}
              <small class="text-muted ms-1">(${hospital.rating})</small>
            </div>
            <button class="btn btn-outline-success select-hospital">Select</button>
          `;
          hospitalsContainer.appendChild(hospitalCard);

          // Add click event to hospital card
          hospitalCard
            .querySelector(".select-hospital")
            .addEventListener("click", function () {
              // Remove selected class from all hospital cards
              document.querySelectorAll(".hospital-card").forEach((card) => {
                card.classList.remove("selected");
              });

              // Add selected class to current hospital card
              hospitalCard.classList.add("selected");
              selectedHospital = hospital;
              document.getElementById("nextToStep2").disabled = false;

              // Automatically proceed to step 2 when hospital is selected
              goToStep(2);
            });
        });
      }

      // Generate star rating
      function generateStars(rating) {
        const fullStars = Math.floor(rating);
        const halfStar = rating % 1 >= 0.5;
        const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);

        let stars = "";
        for (let i = 0; i < fullStars; i++) {
          stars += "★";
        }
        if (halfStar) {
          stars += "★";
        }
        for (let i = 0; i < emptyStars; i++) {
          stars += "☆";
        }

        return stars;
      }

      // Update doctors based on selected department
      function updateDoctors() {
        const department = document.getElementById("departmentSelect").value;
        const doctorSelect = document.getElementById("doctorSelect");
        doctorSelect.innerHTML = '<option value="">Select a doctor</option>';

        if (!department) {
          doctorSelect.disabled = true;
          return;
        }

        const departmentDoctors = doctors[department] || [];
        departmentDoctors.forEach((doctor) => {
          const option = document.createElement("option");
          option.value = doctor.id;
          option.textContent = `${doctor.name} (${doctor.experience})`;
          doctorSelect.appendChild(option);
        });

        doctorSelect.disabled = false;

        // Add change event to doctor select
        doctorSelect.addEventListener("change", function () {
          const doctorId = parseInt(this.value);
          if (doctorId) {
            selectedDoctor = departmentDoctors.find((d) => d.id === doctorId);
            checkStep2Completion();
          } else {
            selectedDoctor = null;
            checkStep2Completion();
          }
        });
      }

      // Set up department and doctors
      function updateDepartmentDoctors() {
        // Reset selections
        document.getElementById("departmentSelect").value = "";
        document.getElementById("doctorSelect").innerHTML =
          '<option value="">Select a doctor</option>';
        document.getElementById("doctorSelect").disabled = true;
        selectedDoctor = null;
        selectedTimeSlot = null;
        checkStep2Completion();
      }

      // Generate time slots
      function generateTimeSlots() {
        const timeSlotsContainer = document.getElementById("timeSlots");
        timeSlotsContainer.innerHTML = "";

        // Generate time slots from 9 AM to 5 PM
        const startHour = 9;
        const endHour = 17;

        for (let hour = startHour; hour < endHour; hour++) {
          for (let minutes of ["00", "30"]) {
            const timeString = `${hour > 12 ? hour - 12 : hour}:${minutes} ${
              hour >= 12 ? "PM" : "AM"
            }`;

            const timeSlot = document.createElement("div");
            timeSlot.className = "time-slot";
            timeSlot.textContent = timeString;
            timeSlot.addEventListener("click", function () {
              document.querySelectorAll(".time-slot").forEach((slot) => {
                slot.classList.remove("selected");
              });
              timeSlot.classList.add("selected");
              selectedTimeSlot = timeString;
              checkStep2Completion();
            });

            timeSlotsContainer.appendChild(timeSlot);
          }
        }
      }

      // Check if step 2 is complete to enable next button
      function checkStep2Completion() {
        document.getElementById("nextToStep3").disabled = !(
          selectedDoctor && selectedTimeSlot
        );
      }

      // Confirm appointment
      function confirmAppointment() {
        // Get form data
        const firstName = document.getElementById("firstName").value;
        const lastName = document.getElementById("lastName").value;
        const email = document.getElementById("email").value;
        const phone = document.getElementById("phone").value;
        const medicalIssue = document.getElementById("medicalIssue").value;

        // Validate form
        if (!firstName || !lastName || !email || !phone || !medicalIssue) {
          alert("Please fill in all required fields.");
          return;
        }

        // Display appointment details
        const appointmentDetails =
          document.getElementById("appointmentDetails");
        appointmentDetails.innerHTML = `
        <div class="card">
          <div class="card-body">
            <p><strong>Patient:</strong> ${firstName} ${lastName}</p>
            <p><strong>Hospital:</strong> ${selectedHospital.name}</p>
            <p><strong>Doctor:</strong> ${selectedDoctor.name}</p>
            <p><strong>Date:</strong> ${getTomorrowDate()}</p>
            <p><strong>Time:</strong> ${selectedTimeSlot}</p>
            <p><strong>Medical Issue:</strong> ${medicalIssue}</p>
          </div>
        </div>
      `;

        // Store appointment data for ticket generation
        window.appointmentData = {
          patientName: `${firstName} ${lastName}`,
          patientEmail: email,
          patientPhone: phone,
          hospital: selectedHospital.name,
          hospitalAddress: selectedHospital.address,
          doctor: selectedDoctor.name,
          doctorQualification: selectedDoctor.qualification,
          department: document.getElementById("departmentSelect").value,
          date: getTomorrowDate(),
          time: selectedTimeSlot,
          medicalIssue: medicalIssue,
          appointmentId: generateAppointmentId(),
        };

        // Move to confirmation step
        goToStep(4);

        // Generate and download the ticket automatically
        setTimeout(() => {
          generateAppointmentTicket();
        }, 1000);
      }

      // Generate a unique appointment ID
      function generateAppointmentId() {
        const prefix = "KM";
        const timestamp = new Date().getTime().toString().slice(-8);
        const random = Math.floor(Math.random() * 1000)
          .toString()
          .padStart(3, "0");
        return `${prefix}${timestamp}${random}`;
      }

      // Get tomorrow's date as string
      function getTomorrowDate() {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        return tomorrow.toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });
      }

      // Generate and download appointment ticket as PDF
      function generateAppointmentTicket() {
        if (!window.appointmentData) return;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: "portrait",
          unit: "mm",
          format: "a4",
        });

        // Set basic properties
        doc.setFont("helvetica", "bold");
        doc.setFontSize(20);
        doc.setTextColor(25, 135, 84); // Green color

        // Add header with corrected capitalization
        doc.text("KwikMed - Appointment Ticket", 105, 20, { align: "center" });

        // Add logo (using base64 encoded image)
        // Creating a simple green "KM" logo as text since we can't load external images
        doc.setFillColor(25, 135, 84);
        doc.rect(20, 10, 15, 15, "F");
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(12);
        doc.text("KM", 27.5, 17.5, { align: "center" });

        // Reset text color
        doc.setTextColor(25, 135, 84);
        doc.setFontSize(20);

        // Add horizontal line
        doc.setDrawColor(25, 135, 84);
        doc.setLineWidth(0.5);
        doc.line(20, 25, 190, 25);

        // Reset font for content
        doc.setFont("helvetica", "normal");
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);

        // Add ticket information
        let y = 35;

        // Appointment ID and Date - Fix date positioning
        doc.setFont("helvetica", "bold");
        doc.text(
          `Appointment ID: ${window.appointmentData.appointmentId}`,
          20,
          y
        );

        // Display the full date without splitting
        doc.text(`Date: ${window.appointmentData.date}`, 140, y);

        // Patient details
        y += 15;
        doc.text("Patient Information:", 20, y);
        doc.setFont("helvetica", "normal");
        y += 7;
        doc.text(`Name: ${window.appointmentData.patientName}`, 25, y);
        y += 7;
        doc.text(`Phone: ${window.appointmentData.patientPhone}`, 25, y);
        y += 7;
        doc.text(`Email: ${window.appointmentData.patientEmail}`, 25, y);

        // Hospital and doctor details
        y += 15;
        doc.setFont("helvetica", "bold");
        doc.text("Appointment Details:", 20, y);
        doc.setFont("helvetica", "normal");
        y += 7;
        doc.text(`Hospital: ${window.appointmentData.hospital}`, 25, y);
        y += 7;

        // Handle long hospital addresses with text wrapping
        const addressLines = doc.splitTextToSize(
          `Address: ${window.appointmentData.hospitalAddress}`,
          160
        );
        doc.text(addressLines, 25, y);
        y += addressLines.length * 7;

        doc.text(`Department: ${window.appointmentData.department}`, 25, y);
        y += 7;

        // Handle possibly long doctor name and qualification
        const doctorText = `Doctor: ${window.appointmentData.doctor} (${window.appointmentData.doctorQualification})`;
        const doctorLines = doc.splitTextToSize(doctorText, 160);
        doc.text(doctorLines, 25, y);
        y += doctorLines.length * 7;

        doc.text(`Time: ${window.appointmentData.time}`, 25, y);

        // Medical issue
        y += 15;
        doc.setFont("helvetica", "bold");
        doc.text("Medical Issue:", 20, y);
        doc.setFont("helvetica", "normal");
        y += 7;

        // Handle long medical issues with text wrapping
        const splitText = doc.splitTextToSize(
          window.appointmentData.medicalIssue,
          160
        );
        doc.text(splitText, 25, y);

        // Move y position past the wrapped text
        y += splitText.length * 7 + 10;

        // Add instructions
        doc.setFont("helvetica", "bold");
        doc.text("Instructions:", 20, y);
        doc.setFont("helvetica", "normal");
        y += 7;
        doc.text(
          "1. Please arrive 15 minutes before your scheduled appointment time.",
          25,
          y
        );
        y += 7;
        doc.text(
          "2. Bring this ticket (printed or digital) along with your ID proof.",
          25,
          y
        );
        y += 7;
        doc.text(
          "3. Reschedule at least 24 hours in advance if you cannot attend.",
          25,
          y
        );

        // Add footer
        y = 270;
        doc.setDrawColor(25, 135, 84);
        doc.setLineWidth(0.5);
        doc.line(20, y, 190, y);
        y += 7;
        doc.setFont("helvetica", "italic");
        doc.setFontSize(10);
        doc.text(
          "For any queries, please contact KwikMed customer support at 1800-XXX-XXXX",
          105,
          y,
          { align: "center" }
        );
        y += 5;
        doc.text("© 2025 KwikMed. All Rights Reserved.", 105, y + 5, {
          align: "center",
        });

        // Download the PDF
        doc.save(
          `KwikMed_Appointment_${window.appointmentData.appointmentId}.pdf`
        );
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        // Reset everything on page load
        document.getElementById("nextToStep2").disabled = true;
        document.getElementById("nextToStep3").disabled = true;

        // Check for URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const cityParam = urlParams.get("city");
        const hospitalParam = urlParams.get("hospital");
        const addressParam = urlParams.get("address");
        const ratingParam = urlParams.get("rating");
        const stateParam = urlParams.get("state");
        const diseaseParam = urlParams.get("disease");

        // Map diseases to departments - add all possible diseases from the patientcare.html page
        const diseaseToDepart = {
          Cardiology: "Cardiology",
          Neurology: "Neurology",
          Oncology: "Oncology",
          Gastroenterology: "Gastroenterology",
          Endocrinology: "Endocrinology",
          Orthopedics: "Orthopedics",
          Dermatology: "Dermatology",
          Urology: "Urology",
          Pulmonology: "Pulmonology",
          Nephrology: "Nephrology",
          Rheumatology: "Rheumatology",
          Neurosurgery: "Neurology",
          Hepatology: "Gastroenterology",
          Pediatrics: "Pediatrics",
          ENT: "ENT",
          Ophthalmology: "Ophthalmology",
          Hematology: "Oncology",
          Psychiatry: "Neurology",
          Gynecology: "Gynecology",
        };

        // If we have both city and hospital from URL params
        if (cityParam && hospitalParam) {
          // Set city select value
          const citySelect = document.getElementById("citySelect");
          citySelect.value = cityParam;

          // Update hospitals list
          updateHospitals();

          // Create a hospital object if we don't have it in our data
          if (
            !hospitals[cityParam] ||
            !hospitals[cityParam].find((h) => h.name === hospitalParam)
          ) {
            const newHospital = {
              id: 999, // Arbitrary ID for the new hospital
              name: hospitalParam,
              address: addressParam || "Address not provided",
              rating: parseFloat(ratingParam) || 4.5,
            };

            // Add to selected hospital
            selectedHospital = newHospital;

            // Create a visual indicator that this hospital is selected
            setTimeout(() => {
              const hospitalsContainer =
                document.getElementById("hospitalsContainer");
              const hospitalCard = document.createElement("div");
              hospitalCard.className = "hospital-card selected";
              hospitalCard.dataset.id = newHospital.id;
              hospitalCard.innerHTML = `
                <h5>${newHospital.name}</h5>
                <p class="text-muted mb-1">${newHospital.address}</p>
                <div class="text-warning">
                  ${generateStars(newHospital.rating)}
                  <small class="text-muted ms-1">(${newHospital.rating})</small>
                </div>
                <button class="btn btn-success select-hospital" disabled>Selected</button>
              `;
              hospitalsContainer.innerHTML = "";
              hospitalsContainer.appendChild(hospitalCard);

              // Enable next button
              document.getElementById("nextToStep2").disabled = false;

              // Automatically go to step 2
              goToStep(2);

              // Select department based on disease if available
              if (diseaseParam && diseaseToDepart[diseaseParam]) {
                setTimeout(() => {
                  const departmentSelect =
                    document.getElementById("departmentSelect");
                  departmentSelect.value = diseaseToDepart[diseaseParam];
                  updateDoctors(); // Trigger doctor list update
                }, 300);
              }
            }, 300);
          } else {
            // Find the existing hospital in our data
            setTimeout(() => {
              const hospitalElements =
                document.querySelectorAll(".hospital-card");
              for (let el of hospitalElements) {
                const hospital = hospitals[cityParam].find(
                  (h) => h.name === hospitalParam
                );
                if (
                  hospital &&
                  el.querySelector("h5").textContent === hospital.name
                ) {
                  // Simulate click on the hospital
                  el.querySelector(".select-hospital").click();
                  // Automatically go to step 2
                  goToStep(2);

                  // Select department based on disease if available
                  if (diseaseParam && diseaseToDepart[diseaseParam]) {
                    setTimeout(() => {
                      const departmentSelect =
                        document.getElementById("departmentSelect");
                      departmentSelect.value = diseaseToDepart[diseaseParam];
                      updateDoctors(); // Trigger doctor list update
                    }, 300);
                  }

                  break;
                }
              }
            }, 300);
          }
        }

        // Add event listener for download ticket button
        document
          .getElementById("downloadTicketBtn")
          .addEventListener("click", function () {
            generateAppointmentTicket();
          });
      });
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
